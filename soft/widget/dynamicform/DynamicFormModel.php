<?phpnamespace soft\widget\dynamicform;use soft\db\ActiveRecord;use soft\helpers\ArrayHelper;use Yii;use yii\base\InvalidConfigException;use yii\base\Model;/** * Model to save data from DynamicFormWidget * * @property mixed $oldIds * @property-read bool $hasModel */class DynamicFormModel extends Model{    /**     * @var ActiveRecord parent models     */    public $model;    /**     * @var ActiveRecord[] child models     */    public $models;    /**     * @var string|null parent model scenario     */    public $modelScenario;    /**     * @var string|null child models scenario     */    public $modelsScenario;    /**     * @var string     */    public $parentAttribute = 'id';    /**     * @var array attributes and values  for parent model     * @see self::setAttributeValues()     */    public $modelAttributes = [];    /**     * @var array attributes and values  for child models     */    public $modelsAttributes = [];    /**     * @var string child models classname     */    public $modelClass;    /**     * @var bool|string sort attribute name for child models     */    public $sortAttribute = false;    /**     * @var bool     * @see self::deleteOldIds()     */    public $deleteOldModels = false;    /**     * @var string     */    public $successMessage;    /**     * @var string     */    public $errorMessage = "Ma'lumotlarni saqlashda xatolik yuz berdi!";    private $_oldIds = [];    public function init()    {        parent::init();        if (empty($this->modelClass)) {            throw new InvalidConfigException("The 'modelClass' property must be set!");        }        if (empty($this->models)) {            $this->models = [new $this->modelClass];        }    }    /**     * Ma'lumotlarni load qilish va saqlash     * @param null $data     * @return bool     * @throws \yii\db\Exception     */    public function loadSave($data = null)    {        return $this->loadData($data) && $this->save();    }    /**     * Parent modelga ma'lumotlarni load qilish     * @param null|array $data     * @return bool     * @see Model::load()     */    public function loadData($data = null)    {        if ($data == null) {            $data = Yii::$app->request->post();        }        if (empty($data)) {            return false;        }        if ($this->hasModel) {            $this->model->load($data);        }        if ($this->deleteOldModels) {            $this->oldIds = ArrayHelper::map($this->models, 'id', 'id');        }        $this->models = $this->createMultiple($data);        return Model::loadMultiple($this->models, $data);    }    /**     * Creates and populates a set of models.     * @param $data     * @return array     * @throws \Exception     */    public function createMultiple($data)    {        $model = new $this->modelClass;        $formName = $model->formName();        $items = ArrayHelper::getValue($data, $formName);        $models = [];        if (!empty($this->models)) {            $keys = array_keys(ArrayHelper::map($this->models, 'id', 'id'));            $this->models = array_combine($keys, $this->models);        }        if ($items && is_array($items)) {            foreach ($items as $i => $item) {                if (isset($item['id']) && !empty($item['id']) && isset($this->models[$item['id']])) {                    $models[] = $this->models[$item['id']];                } else {                    $models[] = new $this->modelClass;                }            }        }        unset($model, $formName, $items);        return $models;    }    /**     * Save parent model and child models     * @return bool     * @throws \yii\db\Exception     */    public function save()    {        $this->deleteOldIds();        $this->setSort();        $this->setAttributeValues();        $result = $this->saveModels();        if ($result && $this->successMessage) {            Yii::$app->session->setFlash('success', $this->successMessage);        }        if (!$result && $this->errorMessage) {            Yii::$app->session->setFlash('error', $this->errorMessage);        }        return $result;    }    /**     * Set sorting values for child models     */    public function setSort()    {        if ($this->sortAttribute !== false) {            $sortAttribute = $this->sortAttribute;            foreach ($this->models as $index => $model) {                $model->$sortAttribute = $index;            }        }    }    /**     * Set attribute values for parent model and child models     * @see self::$modelAttributes     * @see self::$modelsAttributes     */    public function setAttributeValues()    {        // set parent model attributes        if ($this->hasModel) {            if ($this->modelScenario) {                $this->modelAttributes['scenario'] = $this->modelScenario;            }            $this->model->setAttributes($this->modelAttributes, false);        }        // set child multiple models attributes        foreach ($this->models as $key => $model) {            if ($this->modelsScenario) {                $this->models[$key]['scenario'] = $this->modelsScenario;            }            $this->models[$key]->setAttributes($this->modelsAttributes, false);        }    }    /**     * Delete old models     * @see self::$deleteOldModels     */    public function deleteOldIds()    {        $oldIDs = $this->oldIds;        if ($this->deleteOldModels) {            $deletedIDs = array_diff($oldIDs, array_filter(ArrayHelper::map($this->models, 'id', 'id')));            if (!empty($deletedIDs)) {                foreach ($deletedIDs as $id) {                    $model = $this->modelClass::findOne($id);                    if ($model != null) {                        $model->delete();                    }                }            }        }    }    /**     *  Validate and save all models     * @return bool     * @throws \yii\db\Exception     */    public function saveModels()    {        $valid = true;        if ($this->hasModel) {            $valid = $this->model->validate();        }        $valid = Model::validateMultiple($this->models) && $valid;        if ($valid) {            $transaction = \Yii::$app->db->beginTransaction();            try {                $flag = true;                // save parent model                if ($this->hasModel) {                    $flag = $this->model->save(false);                }                if ($flag) {                    // save child models                    foreach ($this->models as $model) {                        if (!($flag = $model->save(false))) {                            $transaction->rollBack();                            break;                        }                    }                }                if ($flag) {                    $transaction->commit();                    // if success return true                    return true;                }            } catch (\Exception $e) {                $transaction->rollBack();            }        }        return false;    }    /**     * Check if the widget has single parent model     * @return bool     */    public function getHasModel()    {        return $this->model != null;    }    /**     * @return mixed     */    public function getOldIds()    {        return $this->_oldIds;    }    /**     * @param mixed $oldIds     */    public function setOldIds($oldIds)    {        $this->_oldIds = $oldIds;    }}?>